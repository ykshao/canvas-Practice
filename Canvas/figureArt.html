<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1">
        <meta name="description" content="">
        <title></title>
        <link rel="stylesheet" href="css/normalize.css">
        <style>
            body {
                background-color: #f00;
                width: 100%; height: 100%;
                overflow: hidden;
            }

            img { 
                position: absolute;
                left: 0;
                top: 0;
            }
            canvas {
                position: absolute;
                z-index: 1;
            }

            #wrap{
                position: absolute;
                width: 648px;
                height: 382px;
                left:50%; margin-left: -324px;
                top:50%; margin-top: -192px;
                background-color: #000;

            }

            #myCanvas {

            }   

        </style>
        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="js/jquery.easing.1.3.js"></script>
        <script src="js/canvas-0.02.js"></script>
        <script src="js/firefly.js"></script>

        <script>
            $(document).ready(function(){
                var img = new Image();
                img.src = 'img/photo1.jpg';
                img.onload = function(){
                    var canvas = new Canvas('#canvasWrap',0,img.width,img.height);
                    $(canvas).bind(canvas.EVENT_CHANGE,function(e,data){
                        if(data.type == 'ready'){
                            canvas.drawImage(img,0,0);
                            canvas.getImageData({},function(imgData){
                                // setBlobUrl(JSON.stringify(imgData.data));
                                // setBlobUrl(JSON.stringify(imgData.data));

                                var fd = new FigureDraw(imgData,'circle',canvas.getContext());
                                canvas.addDrawList('figureDraw',fd)
                                canvas.start();
                                ctx = canvas.getContext();
                                // $(canvas.getCanvas()).on('mousemove',function(e){
                                    // ctx.globalCompositeOperation = 'lighter';
                                    // canvas.drawImage(img,0,0);
                                    
                                    // ctx.save();
                                    // ctx.beginPath();
                                    // ctx.fillStyle = 'rgba('+255+','+255+','+255+','+1+')';
                                    // ctx.clearRect(e.clientX-50, e.clientY-50, 100,100)
                                    // ctx.arc(e.clientX, e.clientY, 100, 0, Math.PI*2, true);
                                    // ctx.fill();
                                    // ctx.restore();
                                // });
                            });
                            canvas.draw = function(){
                                // canvas.drawImage(img,0,0);
                            }
                        }
                    })
                }
            });

            // Aタグのhref属性に、Blobを設定する。
            // Blobに含めるデータは、引数で指定する。
            function setBlobUrl(content) {
                // 指定されたデータを保持するBlobを作成する。
                var blob = new Blob([ content ], { "type" : "application/json" });

                // Aタグのhref属性にBlobオブジェクトを設定する。
                window.URL = window.URL || window.webkitURL;
                $("#download").attr("href", window.URL.createObjectURL(blob));

                // console.log(content);
            }

            // $("#canvasWrap").keyup(function(){
            //     setBlobUrl("download", content);
            // });

            // $("#canvasWrap").keyup();


            var FigureDraw = function(imgData,drawType,ctx){
                var lists       = [],
                    max         = 500;
                this.globalAlpha = .3;

                this.draw = function(ctx){
                    for(var o in lists){
                        var data = lists[o];
                        data.a += (1-data.a)*data.sp;
                        if(data.composite == 'lighter'){
                            if(data.a > .3999)data.a = 1;
                        }else{
                            if(data.a > .9999)data.a = 1;
                        }
                        

                        switch(data.type){
                            case 'square' : this.draw_square(data,ctx); break;
                            case 'circle' : this.drwa_circle(data,ctx); break;
                        }

                        if(data.a >= 1){
                            lists[o] = this.makeFigure();
                        }
                    }
                }

                this.init = function(){
                    for(var i=0; i<max; i++){
                        var f = this.makeFigure();
                        f.a = 1;
                        lists.push(f);
                    }

                    for(var i=0; i<5000; i++){
                        var f = this.makeFigure();
                        f.a = 1;
                        f.w = 15*Math.random();
                        f.h = 15*Math.random();
                        f.x = Math.floor(Math.random()*(imgData.width-f.w));
                        f.y = Math.floor(Math.random()*(imgData.height-f.h));
                        var data = imgData.data[f.x][f.y];
                        f.r = data.r;
                        f.g = data.g;
                        f.b = data.b;
                        switch(drawType){
                            case 'square' : this.draw_square(f,ctx); break;
                            case 'circle' : this.drwa_circle(f,ctx); break;
                        }
                    }

                    this.globalAlpha = .1;
                }

                this.makeFigure = function(){
                    var type    = drawType,
                        w       = 15*Math.random()+1,
                        h       = 15*Math.random()+1,
                        a       = 0,
                        c       = 10*Math.random(),
                        x       = Math.floor(Math.max(0,(Math.random()*imgData.width)-w*0.5)),
                        y       = Math.floor(Math.max(0,(Math.random()*imgData.height)-h*0.5));
                        var data    = imgData.data[x][y],
                        composite = Math.random()<0.01?'lighter':'source-over';

                    return {
                        x : x,
                        y : y,
                        w : w,
                        h : h,
                        a : a,
                        c : c,
                        r : data.r,
                        g : data.g,
                        b : data.b,
                        type : type,
                        composite : composite,
                        sp : Math.random()*Math.random()
                    };
                }



                this.draw_square = function(data,ctx){
                    ctx.save();
                    ctx.fillStyle = 'rgba('+data.r+','+data.g+','+data.b+','+data.a*this.globalAlpha+')';
                    ctx.fillRect(data.x+data.w*(1-data.a)*0.5,data.y+data.h*(1-data.a)*0.5,data.w*data.a,data.h*data.a);
                    ctx.restore();
                    ctx.globalCompositeOperation = data.composite;
                }

                this.drwa_circle = function(data,ctx){
                    ctx.save();
                    ctx.beginPath();
                    ctx.fillStyle = 'rgba('+data.r+','+data.g+','+data.b+','+data.a*this.globalAlpha+')';
                    ctx.arc(data.x, data.y, data.c, 0, Math.PI*2, true);
                    ctx.fill();
                    ctx.restore();
                    ctx.globalCompositeOperation = data.composite;
                    
                }


                this.init();
            }



            FigureDraw.prototype.constructor  = FigureDraw;
             
        </script>
    </head>
    <body> 
        </div>
        <!-- <img class="photo" src="img/photo1.jpg"> -->
        <div id="canvasWrap">
            <a id="download" target="_blank">ダウンロード</a>
        </div>

    </body>
</html>



<!--  
 HTMLCanvasElement

    toDataURL()
    getContext()

 メソッド
    addColorStop()
    arc()
    arcTo()
    beginPath()
    bezierCurveTo()
    clearRect()
    clip()
    closePath()
    createImageData()
    createLinearGradient()
    createPattern()
    createRadialGradient()
    drawFocusRing()
    drawImage()
    fill()
    fillRect()
    fillText()
    getImageData()
    isPointInPath()
    lineTo()
    measureText()
    moveTo()
    putImageData()
    quadraticCurveTo()
    rect()
    restore()
    rotate()
    save()
    scale()
    setTransform()
    stroke()
    strokeRect()
    strokeText()
    translate()
    transform()

プロパティ
    fillStyle
    font
    globalAlpha
    globalCompositeOperation
    lineCap
    lineJoin
    lineWidth
    miterLimit
    shadowBlur
    shadowColor
    shadowOffsetX
    shadowOffsetY
    strokeStyle
    textAlign
    textBaseline
 */

 -->