<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1">
        <meta name="description" content="">
        <title></title>
        <link rel="stylesheet" href="css/normalize.css">
        <style>
            body {
                background-color: #fff4ed;
                width: 100%; height: 100%;
                overflow: hidden;
            }

            #wrap{
                position: absolute;
                width: 648px;
                height: 382px;
                left:50%; margin-left: -324px;
                top:50%; margin-top: -192px;
                background-color: #000;

            }

            #img-color {
                position: absolute;
                left:300px;
                top:200px;
            }   

            #canvasWrap,#canvasWrap2 {
                position: absolute;
            }

        </style>
        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="js/jquery.easing.1.3.js"></script>
        <script src="js/canvas.js"></script>
        <script src="js/effect.powder.js"></script>

        <script>
            $(document).ready(function(){
                var canvas  = new Canvas('#canvasWrap',0,1280,800),
                    ctx     = canvas.getContext();

                var canvas2  = new Canvas('#canvasWrap2',1,1280,800),
                    ctx2     = canvas2.getContext();

                var drawImg = new Image();
                drawImg.src = 'img/portfolio-img-01.png';
                drawImg.onload = function(){
                    var width   = drawImg.width,
                        height  = drawImg.height;
                    var startP = {x:0,y:0},
                        lastP  = {x:width,y:height},
                        dist   = {x:startP.x-lastP.x, y: startP.y-lastP.y};
                    
                    var diagonal = parseInt(Math.sqrt(dist.x*dist.x+dist.y*dist.y));

                    var brushDis = diagonal/brushSize;

                    var points = [],cnt=0;
                    for(var i=0,n=brushDis; i<n; i++){
                        var dis = i*brushSize;
                        var color = 'rgba(0,0,0,1)'

                        if(dis>diagonal*0.5){
                            color = 'rgba(255,0,0,1)'
                        }

                        console.log(color)

                        var x = 300 + dis,
                            y = 200 + dis;

                        points.push({x:0+300,y:y});
                        points.push({x:x,y:0+200});
                        // console.log(i*brushDis);
                    }

                    for(var i=0,n=points.length; i<n; i++){
                        var p = points[i];

                        ctx2.save();
                        ctx2.fillStyle = color;
                        ctx2.beginPath();
                        ctx2.arc(p.x, p.y, 2, 0, 360*Math.PI/180, true);
                        ctx2.closePath();
                        ctx2.fill();
                        ctx2.restore();
                        
                        var id = i+1;
                        if(id%2==0){
                            var prevP = points[i-1];
                            ctx2.save();
                            ctx2.strokeStyle = color;
                            ctx2.beginPath();
                            ctx2.moveTo(prevP.x,prevP.y);
                            ctx2.lineTo(p.x, p.y);
                            ctx2.stroke();
                            ctx2.restore();
                        }

                        if(i == n-1){
                            var prevP = points[i-1];
                            ctx2.save();
                            ctx2.strokeStyle = color;
                            ctx2.beginPath();
                            ctx2.moveTo(300,200);
                            ctx2.lineTo(300+width, 200+height);
                            ctx2.stroke();
                            ctx2.restore();
                        }
                    }
                }
                
                $(canvas).bind(canvas.EVENT_CHANGE,function(e,data){
                    if(data.type == 'ready'){
                        canvas.start();
                        ctx.save();
                        ctx.fillStyle = 'fff4ed';
                        ctx.fillRect(300,200,drawImg.width,drawImg.height);
                        ctx.restore();
                    };
                });


                var sketchPowder,colorData;
                $(canvas2).bind(canvas.EVENT_CHANGE,function(e,data){
                    if(data.type == 'ready'){
                        canvas2.start();
                        canvas2.drawImage(drawImg,300,200);
                        sketchPowder    = new SketchPowder(canvas2);
                        colorData = canvas2.getImageData({x:300,y:200,width:drawImg.width,height:drawImg.height});
                        var cvs = canvas2.getCanvas();
                        $(cvs).bind("mousemove",onMousemove);
                        $(cvs).bind("mousedown",onMousedown);
                        $(cvs).bind("mouseup",onMouseup);

                        // ctx.save();
                        // ctx.fillStyle = 'rgba(255,0,0,1)';
                        // ctx.fillRect(0,0,ctx.width,ctx.height);
                        // ctx.restore();
                    }
                });

                canvas.draw = function(ctx){
                    
                }

                canvas2.draw = function(ctx){
                    // canvas2.clear()
                    sketchPowder.draw();
                    // canvas2.drawImage(drawImg,300,200);
                    // if (!isDrawing) return;
                    
                    var info = {};

                    for(var i = 0 ; i < 10; i++){
                        var cx = x+10-(i%10)+20,
                            cy = y+10-(i%10)+20;

                        if(colorData.data[cx] && colorData.data[cx][cy]){
                            info = { color:colorData.data[cx][cy] };
                            sketchPowder.make(cx,cy,info);
                        }    
                    }
                }

                var isDrawing = false,
                    lastPoint,
                    x,y;

                var brush = new Image();
                brush.src = 'img/brush2.png';
                var brushSize = 40;

                function onMousemove(e){
                    if (!isDrawing) return;
                    // canvas.drawImage(img,300,200);
                    var mouse = { x:e.clientX, y:e.clientY};
                    if(sketchPowder){
                        sketchPowder.mouse.crt = mouse;
                    }

                    currentPoint = { x: e.clientX, y: e.clientY };
                    dist = distanceBetween(lastPoint, currentPoint);
                    angle = angleBetween(lastPoint, currentPoint);
                    ctx.globalCompositeOperation = 'destination-out';

                    for (var i = 0; i < dist; i++) {
                        x = parseInt(lastPoint.x + (Math.sin(angle) * i) - 20);
                        y = parseInt(lastPoint.y + (Math.cos(angle) * i) - 20);
                        ctx.drawImage(brush, x, y);
                    }


                    
                    lastPoint = currentPoint;
                }

                function onMousedown(e){
                    isDrawing = true;
                    x = e.clientX;
                    y = e.clientY;
                    lastPoint = { x: e.clientX, y: e.clientY };
                }

                function onMouseup(){
                    isDrawing = false;
                }

                function distanceBetween(point1, point2) {
                  return Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
                }
                function angleBetween(point1, point2) {
                  return Math.atan2( point2.x - point1.x, point2.y - point1.y );
                }
            });
             
        </script>
    </head>
    <body> 
        <img id="img-color" src="img/portfolio-img-01.png" alt="">
        <div id="canvasWrap"></div>
        <div id="canvasWrap2"></div>
    </body>
</html>



<!--  
 HTMLCanvasElement

    toDataURL()
    getContext()

 メソッド
    addColorStop()
    arc()
    arcTo()
    beginPath()
    bezierCurveTo()
    clearRect()
    clip()
    closePath()
    createImageData()
    createLinearGradient()
    createPattern()
    createRadialGradient()
    drawFocusRing()
    drawImage()
    fill()
    fillRect()
    fillText()
    getImageData()
    isPointInPath()
    lineTo()
    measureText()
    moveTo()
    putImageData()
    quadraticCurveTo()
    rect()
    restore()
    rotate()
    save()
    scale()
    setTransform()
    stroke()
    strokeRect()
    strokeText()
    translate()
    transform()

プロパティ
    fillStyle
    font
    globalAlpha
    globalCompositeOperation
    lineCap
    lineJoin
    lineWidth
    miterLimit
    shadowBlur
    shadowColor
    shadowOffsetX
    shadowOffsetY
    strokeStyle
    textAlign
    textBaseline
 */

 -->