// Image provided by the generous Sally Pesavento
// http://all-free-download.com/free-photos/brickB.html
Graffiti=function(){var e=new Image;e.src="./Images/brick.jpg",e.onload=function(){app.page.background.staticContext.drawImage(e,0,0,app.page.width,e.height*app.page.width/e.width),app.page.background.needsRender=!0,app.page.background.renderProgress()}},Ocean=function(){var e=app.page.background.staticContext,t=e.createLinearGradient(0,0,0,app.page.height);t.addColorStop(0,"rgba(15,70,230,1)"),t.addColorStop(1,"rgba(10,20,110,1)"),e.beginPath(),e.fillStyle=t,e.rect(0,0,app.page.width,app.page.height),e.fill();for(var n=0;n<500;n++)e.beginPath(),e.fillStyle="rgba(255, 255, 255, "+Math.random()*.2+")",e.arc(Math.random()*app.page.width,Math.random()*app.page.height,Math.random()*15,0,2*Math.PI,!1),e.fill();app.page.background.needsRender=!0,app.page.background.renderProgress(),app.page.activeLayer().fillStyle="rgba(10,125,255,.25)"},Space=function(){var e=app.page.background.staticContext;e.fillStyle="rgba(0,0,0,1)",e.beginPath(),e.rect(0,0,app.page.width,app.page.height),e.fill();var t=app.page.width/2,n=app.page.height/2;for(var r=0;r<2e3;r++){e.beginPath();var i=Math.round(255*Math.random()),s=Math.random()*.5;e.fillStyle="rgba("+i+", "+Math.round(128-.5*i)+", "+(255-i)+", "+s+")";var o=Math.random()*2,u=Math.random()*Math.PI*2,a=Math.random()*t;for(var f=0;f<5*o;f++)e.arc(t+Math.cos(u)*a,n+Math.sin(u)*a,o,0,2*Math.PI,!1),e.fill(),s*=.8,e.fillStyle="rgba("+i+", "+Math.round(128-.5*i)+", "+(255-i)+", "+s+")",a*=1.02,u+=.08}app.page.background.needsRender=!0,app.page.background.renderProgress()};var Anchor=function(e,t){this.x=Math.round(e.position.x),this.y=Math.round(e.position.y),this.distance=e.distance,this.direction=t.direction(),this.velocity=t.tipVelocity()},Boundary=function(e,t,n){this.width=t,this.height=n,e[0]<0?this.left=0:e[0]>this.width?this.left=this.width:this.left=e[0],e[1]<0?this.right=0:e[1]>this.width?this.right=this.width:this.right=e[1],e[2]<0?this.top=0:e[2]>this.height?this.top=this.height:this.top=e[2],e[3]<0?this.bottom=0:e[3]>this.height?this.bottom=this.height:this.bottom=e[3]};Boundary.prototype.update=function(e){var t=!1;return e[0]<this.left&&(e[0]<0?this.left=0:e[0]>this.width?this.left=this.width:this.left=e[0],t=!0),e[1]>this.right&&(e[1]<0?this.right=0:e[1]>this.width?this.right=this.width:this.right=e[1],t=!0),e[2]<this.top&&(e[2]<0?this.top=0:e[2]>this.height?this.top=this.height:this.top=e[2],t=!0),e[3]>this.bottom&&(e[3]<0?this.bottom=0:e[3]>this.height?this.bottom=this.height:this.bottom=e[3],t=!0),t},Boundary.prototype.toString=function(){return JSON.stringify([this.left,this.right,this.top,this.bottom])};var Brush=function(){};Brush.prototype={start:function(e,t){},draw:function(e,t,n){}};var DistanceBrush=new Brush;DistanceBrush.minSize=0,DistanceBrush.maxSize=10,DistanceBrush.id=0,DistanceBrush.start=function(e,t){var n=(1-t.distance)*(this.maxSize-this.minSize)+this.minSize;return e.beginPath(),e.arc(t.x,t.y,n,0,2*Math.PI,!1),e.fill(),[t.x-n,t.x+n,t.y-n,t.y+n]},DistanceBrush.draw=function(e,t,n){var r=(1-t.distance)*(this.maxSize-this.minSize)+this.minSize,i=(1-n.distance)*(this.maxSize-this.minSize)+this.minSize,s=new Leap.Vector([t.x,t.y,0]),o=new Leap.Vector([n.x,n.y,0]),u=o.minus(s),a=new Leap.Vector([u.y,-u.x,0]);a=a.normalized();var f=a.multiply(r);a=a.multiply(i);var l=o.plus(a);e.beginPath();var c=l;e.moveTo(c.x,c.y),c=o.minus(a),e.lineTo(c.x,c.y),c=s.minus(f),e.lineTo(c.x,c.y),c=s.plus(f),e.lineTo(c.x,c.y),c=l,e.lineTo(c.x,c.y),e.fill(),e.beginPath(),e.arc(o.x,o.y,i,0,2*Math.PI,!1),e.fill();var h=[t.x-r,t.x+r,t.y-r,t.y+r],p=[n.x-i,n.x+i,n.y-i,n.y+i];return[h,p]};var TiltBrush=new Brush;TiltBrush.minSize=0,TiltBrush.maxSize=40,TiltBrush.id=1,TiltBrush.start=function(e,t){var n=2*t.direction.angleTo(this.normal)/Math.PI,r=n*(this.maxSize-this.minSize)+this.minSize;return e.beginPath(),e.arc(t.x,t.y,r,0,2*Math.PI,!1),e.fill(),[t.x-r,t.x+r,t.y-r,t.y+r]},TiltBrush.draw=function(e,t,n){var r=2*t.direction.angleTo(this.normal)/Math.PI,i=r*(this.maxSize-this.minSize)+this.minSize,s=2*n.direction.angleTo(this.normal)/Math.PI,o=s*(this.maxSize-this.minSize)+this.minSize,u=new Leap.Vector([t.x,t.y,0]),a=new Leap.Vector([n.x,n.y,0]),f=a.minus(u),l=new Leap.Vector([f.y,-f.x,0]);l=l.normalized();var c=l.multiply(i);l=l.multiply(o);var h=a.plus(l);e.beginPath();var p=h;e.moveTo(p.x,p.y),p=a.minus(l),e.lineTo(p.x,p.y),p=u.minus(c),e.lineTo(p.x,p.y),p=u.plus(c),e.lineTo(p.x,p.y),p=h,e.lineTo(p.x,p.y),e.fill(),e.beginPath(),e.arc(a.x,a.y,o,0,2*Math.PI,!1),e.fill();var d=[t.x-i,t.x+i,t.y-i,t.y+i],v=[n.x-o,n.x+o,n.y-o,n.y+o];return[d,v]};var BubbleBrush=new Brush;BubbleBrush.minSize=0,BubbleBrush.maxSize=10,BubbleBrush.id=2,BubbleBrush.start=function(e,t){var n=(1-t.distance)*(this.maxSize-this.minSize)+this.minSize;return e.beginPath(),e.arc(t.x,t.y,n,0,2*Math.PI,!1),e.fill(),[t.x-n,t.x+n,t.y-n,t.y+n]},BubbleBrush.draw=function(e,t,n){var r=(1-n.distance)*(this.maxSize-this.minSize)+this.minSize;e.beginPath(),e.arc(n.x,n.y,r,0,2*Math.PI,!1),e.fill();var i=[n.x-r,n.x+r,n.y-r,n.y+r];return[i]};var SpeedBrush=new Brush;SpeedBrush.minSize=1,SpeedBrush.maxSize=10,SpeedBrush.maxSpeed=1200,SpeedBrush.id=3,SpeedBrush.start=function(e,t){var n=t.velocity.magnitude()/this.maxSpeed;n>1&&(n=1);var r=(1-n)*(this.maxSize-this.minSize)+this.minSize;return e.beginPath(),e.arc(t.x,t.y,r,0,2*Math.PI,!1),e.fill(),[t.x-r,t.x+r,t.y-r,t.y+r]},SpeedBrush.draw=function(e,t,n){var r=t.velocity.magnitude()/this.maxSpeed;r>1&&(r=1);var i=(1-r)*(this.maxSize-this.minSize)+this.minSize,s=n.velocity.magnitude()/this.maxSpeed;s>1&&(s=1);var o=(1-s)*(this.maxSize-this.minSize)+this.minSize,u=new Leap.Vector([t.x,t.y,0]),a=new Leap.Vector([n.x,n.y,0]),f=a.minus(u),l=new Leap.Vector([f.y,-f.x,0]);l=l.normalized();var c=l.multiply(i);l=l.multiply(o);var h=a.plus(l);e.beginPath();var p=h;e.moveTo(p.x,p.y),p=a.minus(l),e.lineTo(p.x,p.y),p=u.minus(c),e.lineTo(p.x,p.y),p=u.plus(c),e.lineTo(p.x,p.y),p=h,e.lineTo(p.x,p.y),e.fill(),e.beginPath(),e.arc(a.x,a.y,o,0,2*Math.PI,!1),e.fill();var d=0;s<.01&&Math.random()<.05&&(d=Math.random()*40,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x,a.y+o+d),e.lineWidth="2px",e.strokeStyle=e.fillStyle,e.stroke());var v=[t.x-i,t.x+i,t.y-i,t.y+i],m=[n.x-o,n.x+o,n.y-o,n.y+o+d];return[v,m]};var HistoryGesture=function(e,t){this.undo=e,this.redo=t,this.reset()};HistoryGesture.prototype={reset:function(){this.gid=-1,this.progress=0},update:function(e){if(this.gid==-1){var t=e.gestures();if(t.count()>1){var n=t[0];this.gid=n.id(),n.normal().angleTo(n.pointable().direction())>Math.PI/2?this.action=this.undo:this.action=this.redo,this.progress=Math.floor(n.progress())}else this.reset()}else{var n=e.gesture(this.gid);n.isValid()?this.apply(n):this.reset()}},apply:function(e){while(this.progress<Math.floor(e.progress()))this.action(),this.progress++}};var InkFile=function(e){this.O=[];for(var t in e.layers)this.O.push(e.layers[t].history)};InkFile.prototype={tostring:function(){return JSON.stringify(this.O)}};var InkMotion=function(){var e=this;this.div=document.getElementById("InkMotion"),this.div.oncontextmenu=function(){return e.F(),!1},this.page=new Page(window.innerWidth,window.innerHeight,this),this.pageDiv=document.createElement("div"),this.pageDiv.appendChild(this.page.div),this.div.appendChild(this.pageDiv),this.HistoryGesture=new HistoryGesture(function(){e.P()},function(){e.N()}),this.foreground=new Layer(window.innerWidth,window.innerHeight),this.div.appendChild(this.foreground.canvas),this.J(),this.div.appendChild(this.menu.ul),this.listener=new Leap.Listener,this.listener.onConnect=function(t){e.C(t)},this.controller=new Leap.Controller("ws://localhost:6437/"),this.controller.addListener(this.listener),this.controller.enableGesture("circle",!0),setTimeout(function(){e.controller.isConnected()||e.E()},2e3),this.brush=DistanceBrush,this.activeDistance=40,this.projection=function(e){return this.screen.intersect(e,!0)}};InkMotion.prototype={D:function(e){var t=this.page.activeLayer(),n=e.frame(),r=n.pointables(),i=r.count();Object.keys(t.progress).length==0?this.HistoryGesture.update(n):this.HistoryGesture.reset();for(var s in t.progress)n.pointable(s).isValid()||t.finalizeStroke(s);this.screen.offset();for(var o=0;o<i;o++){var u=r[o],a=this.projection(u,!0);if(a){a.distance/=this.activeDistance;var f=new Anchor(a,u);t.processAnchor(u.id(),f,this.brush)}}},A:function(){var e=this.controller.frame(),t=e.pointables(),n=t.count();if(n==0){if(this.needsRender==0)return;this.needsRender=!1}else this.needsRender=!0;this.foreground.context.clearRect(0,0,this.foreground.width,this.foreground.height);for(var r=0;r<n;r++){var i=t[r],s=this.projection(i,!0);if(s){var o=(200-s.distance+this.activeDistance)/200;o>1?o=1:o<0&&(o=0),this.foreground.context.beginPath(),this.foreground.context.arc(s.position.x,s.position.y,2+10*(1-o),0,2*Math.PI,!1),this.foreground.context.fillStyle="rgba(0,0,0,"+o+")",this.foreground.context.fill(),this.foreground.context.beginPath(),this.foreground.context.arc(s.position.x,s.position.y,1+4*(1-o),0,2*Math.PI,!1),this.foreground.context.fillStyle="rgb(255,255,255)",this.foreground.context.fill()}}},C:function(e){var t=document.getElementById("youtube");t&&document.body.removeChild(t);if(this.calibrate||this.screen)return;var n=this;if(this.controller.calibratedScreens().empty())this.calibrate=new Leap.Calibrate(this.controller),this.calibrate.onComplete=function(e){n.screen=e,delete n.calibrate,setTimeout(function(){n.listener.onFrame=function(e){n.D(e)}},1500),n.renderLoop=function(){requestAnimFrame(n.renderLoop),n.page.activeLayer().renderProgress(),n.A()},n.renderLoop()};else{this.screen=this.controller.calibratedScreens()[0],this.listener.onFrame=function(e){n.D(e)},this.renderLoop=function(){requestAnimFrame(n.renderLoop),n.page.activeLayer().renderProgress(),n.A()},this.renderLoop();var r=this.menu.items[0];r.show(),setTimeout(function(){r.hide()},3e3)}},G:function(){if(this.calibrate||!this.controller.isConnected())return;if(!confirm("Are you sure?\nRecalibration takes a few seconds."))return;this.listener.onFrame=function(e){},this.renderLoop=function(){},this.foreground.context.clearRect(0,0,this.foreground.width,this.foreground.height),delete this.screen,this.controller.calibratedScreens().clear(),this.C(this.controller)},M:function(){if(!confirm("Are you sure?\nUnsaved changes will be lost."))return;this.pageDiv.removeChild(this.page.div),delete this.page,this.page=new Page(window.innerWidth,window.innerHeight,this),this.pageDiv.appendChild(this.page.div)},K:function(){var e=(new InkFile(this.page)).tostring(),t=new Blob([e],{type:"application/octet-binary"}),n=webkitURL.createObjectURL(t);window.open(n,"L")},H:function(){var e=this.page.flatten().canvas.toDataURL().match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),t=atob(e[3]),n=new ArrayBuffer(t.length),r=new Uint8Array(n);for(var i=0;i<r.length;i++)r[i]=t.charCodeAt(i);var s=new Blob([r],{type:e[1]}),o=webkitURL.createObjectURL(s);window.open(o,"L")},I:function(){this.page.activeLayer().fillStyle=window.prompt("Fill style:",this.page.activeLayer().fillStyle)},P:function(){this.page.activeLayer().undo()},N:function(){this.page.activeLayer().redo()},J:function(){var e=this;this.menu=new Menu;var t=this.menu.addItem("<img src='./Images/logo.png' />"),n=t.addItem("View Source");n.link.href="https://www.github.com/deckar01/InkMotion/",n.link.target="L",t.addItem("Recalibrate").link.onclick=function(){e.G()};var r=this.menu.addItem("File");r.addItem("New").link.onclick=function(){e.M()},r.addItem("Open"),r.addItem("Save").link.onclick=function(){e.K()},r.addItem("Export").link.onclick=function(){e.H()};var i=this.menu.addItem("Page");i.addItem("Add Layer").link.onclick=function(){e.page.addLayer()},i.addItem("Clear Layer").link.onclick=function(){e.page.activeLayer().clear()},i.addItem("Undo").link.onclick=function(){e.P()},i.addItem("Redo").link.onclick=function(){e.N()};var s=this.menu.addItem("Brush");s.addItem("Fill Style").link.onclick=function(){e.I()};var o=s.addItem("Action");o.addItem("Draw").link.onclick=function(){e.page.activeLayer().globalCompositeOperation="source-over"},o.addItem("Draw On").link.onclick=function(){e.page.activeLayer().globalCompositeOperation="source-atop"},o.addItem("Draw Behind").link.onclick=function(){e.page.activeLayer().globalCompositeOperation="destination-over"},o.addItem("Erase").link.onclick=function(){e.page.activeLayer().globalCompositeOperation="destination-out"};var u=s.addItem("Type");u.addItem("Distance").link.onclick=function(){e.brush=DistanceBrush},u.addItem("Tilt").link.onclick=function(){TiltBrush.normal=Leap.Vector.zero().minus(e.screen.normal()),e.brush=TiltBrush},u.addItem("Bubble").link.onclick=function(){e.brush=BubbleBrush},u.addItem("Speed").link.onclick=function(){e.brush=SpeedBrush};var a=s.addItem("Tracking");a.addItem("Directional").link.onclick=function(){e.projection=function(e){return this.screen.intersect(e,!0)}},a.addItem("Positional").link.onclick=function(){e.projection=function(e){return this.screen.project(e,!0)}};var f=this.menu.addItem("Themes");f.addItem("None").link.onclick=function(){e.page.background.clear(),app.page.background.renderProgress()},f.addItem("Space").link.onclick=Space,f.addItem("Ocean").link.onclick=Ocean,f.addItem("Graffiti").link.onclick=Graffiti},F:function(){},E:function(){var e=document.createElement("div");e.id="youtube",e.classList.add("youtube"),e.innerHTML+='If you have a Leap Motion, ensure it is connected and the Leap application is running.<br/><iframe width="853" height="480" src="http://www.youtube.com/embed/TBHGjIBmBaQ?autoplay=1" frameborder="0" allowfullscreen></iframe>',document.body.appendChild(e)}};var Layer=function(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.classList.add("layer"),this.canvas.width=e,this.canvas.height=t,this.context=this.canvas.getContext("2d"),this.staticCanvas=document.createElement("canvas"),this.staticCanvas.classList.add("layer"),this.staticCanvas.width=e,this.staticCanvas.height=t,this.staticContext=this.staticCanvas.getContext("2d"),this.globalCompositeOperation="source-over",this.fillStyle="#000000",this.cache=[],this.history=[],this.progress={},this.discard=[],this.clears=[],this.lastClear=-1,this.needsRender=!1};Layer.prototype={clear:function(){this.addCache(),this.staticContext.clearRect(0,0,this.width,this.height),this.lastClear=this.history.length,this.clears.push(this.lastClear),this.history.push("clear"),this.needsRender=!0},processAnchor:function(e,t,n){var r=this.progress[e],i=Math.abs(t.distance)<=1;r?i?r.update(t):this.finalizeStroke(e):i&&(this.progress[e]=new Stroke(this.canvas,this.globalCompositeOperation,this.fillStyle,n,t)),this.needsRender=!0},finalizeStroke:function(e){var t=this.progress[e];t.finalize(),t.visible()&&(this.addCache(),this.staticContext.globalCompositeOperation=t.globalCompositeOperation,this.staticContext.drawImage(t.canvas,t.x,t.y,t.width,t.height,t.x,t.y,t.width,t.height),t.trash(),this.history.push(t),this.needsRender=!0),delete this.progress[e]},addCache:function(){var e=document.createElement("canvas");e.width=this.width,e.height=this.height;var t=e.getContext("2d");t.globalCompositeOperation="source-over",t.drawImage(this.staticCanvas,0,0),this.cache.push(e)},renderProgress:function(){if(this.needsRender){this.context.clearRect(0,0,this.width,this.height),this.context.globalCompositeOperation="source-over",this.context.drawImage(this.staticCanvas,0,0);for(var e in this.progress){var t=this.progress[e];t.visible()&&(this.context.globalCompositeOperation=t.globalCompositeOperation,this.context.drawImage(t.canvas,t.x,t.y,t.width,t.height,t.x,t.y,t.width,t.height))}this.needsRender=!1}},undo:function(){var e=this.history.pop();if(e){this.discard.push(e),e=="clear"&&(this.clears.pop(),this.lastClear=this.clears[this.clears.length-1]||-1),this.staticContext.clearRect(0,0,this.width,this.height),this.staticContext.globalCompositeOperation="source-over";var t=this.cache.pop();this.staticContext.drawImage(t,0,0),this.needsRender=!0}},redo:function(){var e=this.discard.pop();e&&(this.history.push(e),this.addCache(),e=="clear"?(this.staticContext.clearRect(0,0,this.width,this.height),this.lastClear=this.history.length-1,this.clears.push(this.lastClear)):(e.rebuild(this.canvas),this.staticContext.globalCompositeOperation=e.globalCompositeOperation,this.staticContext.drawImage(e.canvas,e.x,e.y,e.width,e.height,e.x,e.y,e.width,e.height),e.trash()),this.needsRender=!0)}};var Menu=function(){this.items=[],this.ul=document.createElement("ul"),this.ul.classList.add("dropdown")};Menu.prototype={addItem:function(e){var t=new Item(e);return this.items.push(t),this.ul.appendChild(t.li),t}};var Item=function(e){this.items=[],this.title=e,this.li=document.createElement("li"),this.link=document.createElement("a"),this.link.href="#",this.link.innerHTML=e,this.li.appendChild(this.link),this.ul=document.createElement("ul"),this.li.appendChild(this.ul);var t=this;this.li.onmouseover=function(){t.show()},this.li.onmouseout=this.ul.onclick=function(){t.hide()}};Item.prototype={addItem:function(e){var t=new Item(e);return this.items.push(t),this.ul.appendChild(t.li),t},show:function(){this.li.classList.add("hover"),this.ul.style.visibility="visible"},hide:function(){this.li.classList.remove("hover"),this.ul.style.visibility="hidden"}};var Page=function(e,t){this.width=e,this.height=t,this.background=new Layer(e,t),this.layers=[new Layer(e,t)],this.composite=new Layer(e,t),this.activeIndex=0,this.div=document.createElement("div"),this.div.appendChild(this.background.canvas),this.div.appendChild(this.layers[0].canvas)};Page.prototype={addLayer:function(){var e=new Layer(this.width,this.height);return this.activeIndex=this.layers.length,this.layers.push(e),this.div.appendChild(e.canvas),e},flatten:function(){var e=this.composite.context;e.clearRect(0,0,this.width,this.height),e.drawImage(this.background.canvas,0,0);for(index in this.layers)e.drawImage(this.layers[index].canvas,0,0);return this.composite},activeLayer:function(){return this.layers[this.activeIndex]}};var Stroke=function(e,t,n,r,i){this.brush=r,this.path=[i],this.lastAnchor=i,this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.context=this.canvas.getContext("2d"),this.globalCompositeOperation=t,this.fillStyle=n,this.context.fillStyle=n;var s=this.brush.start(this.context,i);this.boundary=new Boundary(s,e.width,e.height),this.x=this.boundary.left,this.y=this.boundary.top,this.width=this.boundary.right-this.x,this.height=this.boundary.bottom-this.y};Stroke.prototype={update:function(e){var t=this.brush.draw(this.context,this.lastAnchor,e),n=!1;for(i in t)n=this.boundary.update(t[i])||n;n&&(this.x=this.boundary.left,this.y=this.boundary.top,this.width=this.boundary.right-this.x,this.height=this.boundary.bottom-this.y),this.path.push(e),this.lastAnchor=e},finalize:function(e){},trash:function(){delete this.canvas,delete this.context},rebuild:function(e){this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.context=this.canvas.getContext("2d"),this.context.fillStyle=this.fillStyle,this.brush.start(this.context,this.path[0]);for(var t=1;t<this.path.length;t++)this.brush.draw(this.context,this.path[t-1],this.path[t]);this.lastAnchor=this.path[t-1]},visible:function(){return this.width>0&&this.height>0}};