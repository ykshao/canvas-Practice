<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1">
        <meta name="description" content="">
        <title></title>
        <link rel="stylesheet" href="css/normalize.css">
        <style>
            #a {
                position: absolute;
                width: 100px;
                height: 100px;
                left:0;
                background-color: #f00;
            }

            #contents {
                position: absolute;
                width: 100%; height: 100%;
                background-color: #000;
                overflow: hidden;
            }
        </style>
        <script src="js/modernizr.custom.min.js"></script>
        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="js/jquery.easing.1.3.js"></script>

        </script>
        <script>
            $(document).ready(function(){

                // Create an <audio> element dynamically.
                var audio = new Audio();
                audio.src = '/sound/tentlondon-intro.mp3';
                audio.controls = true;
                audio.autoplay = true;
                audio.loop = true;
                document.body.appendChild(audio);

                var context = new webkitAudioContext();
                analyser = context.createAnalyser();
                // analyser.smoothingTimeConstant = 0.5;
                analyser.fftSize = 2048;//32~2048;

                 // setup a javascript node
                // javascriptNode = context.createScriptProcessor(256, 1, 1);
                // connect to destination, else it isn't called
                // javascriptNode.connect(context.destination);

                // sourceNode = context.createBufferSource();
                // sourceNode.connect(analyser);
                // analyser.connect(javascriptNode);

                // Wait for window.onload to fire. See crbug.com/112368

                var lines = [];
                for(var i=0; i<100; i++){
                    var div = $('<div></div>');
                    var w =(100/100);
                    div.css({
                        position: 'absolute',
                        width   : w+'%',
                        left    : i*w+'%',
                        height  : '100%',
                        bottom  : 0,
                        backgroundColor : '#f00'
                    });
                    $('#contents').append(div);
                    lines[i] = div;
                }
                window.addEventListener('load', function(e) {
                    // Our <audio> element will be the audio source.
                    var source = context.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(context.destination);
                    requestAnimationFrame(rendering);
                    // console.log(analyser.context);
                    // ...call requestAnimationFrame() and render the analyser's output to canvas.
                }, false);




                function rendering(){

                    requestAnimationFrame(rendering);

                    var freqByteData = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(freqByteData);
                    for(var o in lines){
                        lines[o].css({
                            height : (freqByteData[o]/255)*100+'%'
                        })
                    }
                }

                // var sd = $('#intro')[0];
                // $('#intro').on('loadstart durationchange loadedmetadata loadeddata progress canplay canplaythrough　playing',sdEvent);
                // sd.loadstart = sdEvent
                // sd.durationchange = sdEvent
                // sd.loadedmetadata = sdEvent
                // sd.loadeddata = sdEvent
                // sd.progress = sdEvent
                // sd.canplay = sdEvent
                // sd.canplaythrough = sdEvent

                // function sdEvent(e){
                //     switch(e.type){
                //         case 'loadstart'        : break;
                //         case 'durationchange'   : break;
                //         case 'loadedmetadata'   : break;
                //         case 'loadeddata'       : break;
                //         case 'progress'         : break;//console.log(e.type,e); break;
                //         case 'canplay'          : console.log(e.type,e); sd.play(); break;
                //         case 'canplaythrough'   : break;
                //         case 'playing'          : console.log(e);　break;
                //     }
                // }

                // var keys = [
                // 'audioTracks',
                // 'autoplay',           
                // 'buffered',           
                // 'controller',         
                // 'controls',           
                // 'crossOrigin',        
                // 'currentSrc',         
                // 'currentTime',        
                // 'defaultMuted',       
                // 'defaultPlaybackRate',
                // 'duration',           
                // 'ended',              
                // 'error',              
                // 'loop',               
                // 'mediaGroup',         
                // 'muted',              
                // 'networkState',       
                // 'paused',             
                // 'playbackRate',       
                // 'played',             
                // 'preload',            
                // 'readyState',         
                // 'seekable',           
                // 'seeking',            
                // 'src',                
                // 'startDate',          
                // 'textTracks',         
                // 'videoTracks',        
                // 'volume'
                // ]
                // var timer = setInterval(function(){
                //     // console.log(sd.currentTime);
                //     for(var o in keys){
                //         // console.log(keys[o] +" = "+ sd[keys[o]]);
                //     }
                // },1000/30)

                

                // audioTracks              Returns an AudioTrackList object representing available audio tracks
                // autoplay                 Sets or returns if the audio/video should start playing as soon as it is loaded
                // buffered                 Returns a TimeRanges object representing the buffered parts of the audio/video
                // controller               Returns the MediaController object representing the current media controller of the audio/video
                // controls                 Sets or returns if the audio/video should display controls (like play/pause etc.)
                // crossOrigin              Sets or returns the CORS settings of the audio/video
                // currentSrc               Returns the URL of the current audio/video
                // currentTime              Sets or returns the current playback position in the audio/video (in seconds)
                // defaultMuted             Sets or returns if the audio/video is muted by default
                // defaultPlaybackRate      Sets or returns the default speed of the audio/video playback
                // duration                 Returns the length of the current audio/video (in seconds)
                // ended                    Returns if the playback of the audio/video has ended or not
                // error                    Returns a MediaError object representing the error state of the audio/video
                // loop                     Sets or returns if the audio/video should start over again when finished
                // mediaGroup               Sets or returns the group the audio/video belongs to (used to link multiple audio/video elements)
                // muted                    Sets or returns if the audio/video is muted or not
                // networkState             Returns the current network state of the audio/video
                // paused                   Sets or returns if the audio/video is paused or not
                // playbackRate             Sets or returns the speed of the audio/video playback
                // played                   Returns a TimeRanges object representing the played parts of the audio/video
                // preload                  Sets or returns if the audio/video should be loaded when the page loads
                // readyState               Returns the current ready state of the audio/video
                // seekable                 Returns a TimeRanges object representing the seekable parts of the audio/video
                // seeking                  Returns if the user is currently seeking in the audio/video
                // src                      Sets or returns the current source of the audio/video element
                // startDate                Returns a Date object representing the current time offset
                // textTracks               Returns a TextTrackList object representing the available text tracks
                // videoTracks              Returns a VideoTrackList object representing the available video tracks
                // volume                   Sets or returns the volume of the audio/video

            });
        </script>
    </head>
    <body>
        <div id="contents">
            
        </div>
        <!-- <audio loop id="intro"> -->
          <!-- <source src="/soundhorse.ogg" type="audio/ogg"> -->
          <!-- <source src="/sound/tentlondon-intro.mp3" type="audio/mpeg"> -->
            <!-- Your browser does not support the audio element. -->
        <!-- </audio> -->
    </body>
</html>
